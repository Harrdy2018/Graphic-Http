# 传输层

# OSI模型和DoD模型
***
![](https://github.com/Harrdy2018/Graphic-Http/blob/master/OSI%20and%20DoD.png)
***
```
DoD(Departemnt of Defense 国防部)模型，也就是TCP/IP模型
TCP(Transmission Control Protocol 传输控制协议)
UDP(User Data Protocol 用户数据报协议)
什么时候使用？
TCP:需要将要传输的文件分段，传输建立会话，可靠传输，流量控制
UDP:一个数据报就能完成通信，不需要建立会话，不需要流量控制，不可靠传输
```

***
```
PDU(Protocol Data Unit 协议数据单元)表示对等层之间传递的数据单位
应用层的PDU---------->>报文(message)
传输层的PDU---------->>数据段(segment)
网络层的PDU---------->>数据包(packet)
数据链路层的PDU------>>数据帧(frame)
物理层的PDU---------->>数据位(bit)
```

***
**IP分组的最大字节数是65535字节还是65536字节？？**
```
2^(16)=65536    
区间为0~65535字节
数据包的最大长度的字段是16位，那么这16位所能表示的最大数字就是(2^16-1)，
二进制就是16个1排起来，所以数据包的最大长度就是65535
```

***
# IPv4数据包格式
***
![](https://github.com/Harrdy2018/Graphic-Http/blob/master/IPv4%20packet.png)
***
* **一个IP数据报由首部和数据两部分组成**
* **首部的前一部分是固定长度，一共是32bit`*`5=160bit=20字节，所以我们常说固定首部长度为20字节**
* **在首部的固定部分的后面是一些可选字段，其长度是可变的**
* 一、版本(Version):长度4bit,标识目前采用的 IP 协议的版本号。一般的值为 0100（IPv4),0110（IPv6）
***
|版本号|版本|RFC文档|
|:-----|:-----|:-----|
|0|保留||
|1~3|未分配||
|4|Internet 协议版本 4（IPv4）|RFC791|
|5|ST 数据报（Datagram）|RFC1190|
|6|IPv6|RFC1883|
|7|TP / IX|	RFC1475|
|8|P Internet 协议（PIP）|RFC1621|
|9|使用更大地址的 TCP 和 UDP（TUBA）|RFC1347|
|10~14|未分配||
|15|保留||
***

* 二、首部长度(Header Length):长度 4 bit 。这个字段的作用是为了描述 IP 报头的长度，因为在 IP 报头中有变长的可选部分。
```
该部分占4bit,可表示的最大数值是15个单位(一个单位为4字节)，
即本区域值 = IP 头部长度（单位为字节）/ 长度单位（4 个字节）。
因此，一个 IP 报头的长度最长为 “ 1111 ”，即 15 x 4 个字节 = 60 个字节。
IP 报头最小长度为 20 字节。
```
***
|Header Length|Header Length所代表的实际的IP报头长度|
|:-----|:-----|
|0101|20字节|
|0110|24字节|
|0111|28字节|
|...|...|
|1101|52字节|
|1110|56字节|
|1111|60字节|
***

* 三、服务类型(Type of Service):长度8bit,8位按位被如下定义：PPP DTRC0（更多详细信息可以参见 RFC1340 和 RFC1349）
```
PPP：前 3 位，定义包的优先级，取值越大数据越重要
000 普通（Routine）
001 优先的（Priority）
010 立即的发送（Immediate）
011 闪电式的（Flash）
100 比闪电还闪电式的（Flash Override）
101 CRI / TIC / ECP（找不到这个词的翻译）
110 网间控制（Internetwork Control）
111 网络控制（Network Control）
DTRCO：后 5 位
D 时延：0：普通，1：延迟尽量小
T 吞吐量：0：普通，1：流量尽量大
R 可靠性：0：普通，1：可靠性尽量大
M 传输成本：0：普通，1：成本尽量小
0 最后一位被保留，恒定为 0
```

***
**这里的bit和我们原来以为的1Byte=8bit的含义不一样**
* 四、IP包总长度(Total Length):长度16bit。<br>
**以字节为单位计算的 IP 包的长度（包括头部和数据）,也就是说单位为字节，1bit的话，可表示的最大十进制数为2，相当于2字节**，
所以IP包最大长度2^16-1=65535字节。<br>
所以，数据包有效载荷的大小 = IP包总长度(Total Length)-IP报头长度(Header Length)

***
* 五、标识符（Identifier）：长度 16 bit 。该字段和 Flags 和 Fragment Offest 字段联合使用，对较大的上层数据包进行分段（fragment）操作。路由器将一个包拆分后，所有拆分开的小包被标记相同的值，以便目的端设备能够区分哪个包属于被拆分开的包的一部分。

***
* 六、标记（Flags）：长度 3 bit 。
```
该字段第一位不使用。
第二位是 DF（Don’t Fragment）位，DF 位设为 1 时表明路由器不能对该上层数据包分段。
如果一个上层数据包无法在不分段的情况下进行转发，则路由器会丢弃该上层数据包并返回一个错误信息。
第三位是 MF（More Fragments）位，当路由器对一个上层数据包分段，
则路由器会在除了最后一个分段的 IP 包的报头中将 MF 位设为 1 。
```

***
* 七、片偏移（Fragment Offset）：长度 13 bit，以 8 个八位组为单位。表示该 IP 包在该组分片包中位置，接收端靠此来组装还原 IP 包。

***
* 八、生存时间（Time to Live,TTL）：长度 8 bit，设计之初是以秒（s）为单位的，但实际以跳数为单位，建议的缺省值为 64 。
当 IP 包进行传送时，先会对该字段赋予某个特定的值。当 IP 包经过每一个沿途的路由器的时候，每个沿途的路由器会将 IP 包的 TTL 值减少 1 。
如果 TTL 减少为 0，则该 IP 包会被丢弃。这个字段可以防止由于路由环路而导致 IP 包在网络中不停被转发。

***
* 九、协议（Protocol）：长度 8 bit 。标识了上层所使用的协议。以下是比较常用的协议号：1 ICMP；2 IGMP；6 TCP；17 UDP；88 IGRP；89 OSPF 

***
* 十、10、头部校验（Header Checksum）：长度 16 bit 。用来做 IP 头部的正确性检测，但不包含数据部分。 因为每个路由器要改变 TTL 的值，所以路由器会为每个通过的数据包重新计算这个值（RFC1141 讨论了一些简化计算的策略）。

***
* 十一、起源和目标地址（Source and Destination Addresses）：这两个地址都是 32 bit 。标识了这个 IP 包的起源和目标地址。要注意除非使用 NAT，否则整个传输的过程中，这两个地址不会改变。

***
* 十二、可选项（Options）：这是一个可变长的字段。该字段属于可选项，主要用于测试，由起源设备根据需要改写。可选项目包含以下内容：
```
松散源路由（Loose source routing）：给出一连串路由器接口的 IP 地址。
IP 包必须沿着这些 IP 地址传送，但是允许在相继的两个 IP 地址之间跳过多个路由器。
严格源路由（Strict source routing）：给出一连串路由器接口的 IP 地址。IP 包必须沿着这些 IP 地址传送，
如果下一跳不在 IP 地址表中则表示发生错误。
路由记录（Record route）：当 IP 包离开每个路由器的时候记录路由器的出站接口的 IP 地址。
时间戳（Timestamps）：当 IP 包离开每个路由器的时候记录时间。
填充（Padding）：因为 IP 报头长度（Header Length）部分的单位为 32 bit，所以 IP 报头的长度必须为 32 bit 的整数倍。
因此，在可选项后面，IP 协议会填充若干个 0，以达到 32 bit 的整数倍。
```
